{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='view_class.css') }}">
{% endblock %}

{% block body %}
<div class="class-container">
    <h2>{{ cls.class_name }}</h2>

    <!-- Back to Dashboard -->
    {% if current_user.role == 'teacher' %}
        <a href="{{ url_for('dashboard_teacher') }}" class="back-arrow">&#8592; Dashboard</a>
    {% elif current_user.role == 'student' %}
        <a href="{{ url_for('dashboard_student') }}" class="back-arrow">&#8592; Dashboard</a>
    {% endif %}

    <!-- Notes Section -->
    <div class="notes-section">
        <div class="section-header">
            <h3>Notes:</h3>
            {% if current_user.role == 'teacher' %}
                <a href="{{ url_for('upload_note', class_id=cls.id) }}" class="btn upload-note-btn">Upload Note</a>
            {% endif %}
        </div>
        {% if notes %}
            <ul class="notes-list">
            {% for note in notes %}
                <li>
                    <strong>{{ note.title }}</strong>
                    <a href="{{ url_for('uploaded_file', filename=note.filename) }}" class="view-link">View / Download</a>
                    {% if current_user.role == 'teacher' %}
                        <a href="{{ url_for('update_note', note_id=note.id) }}" class="edit-link">Edit</a>
                        <form action="{{ url_for('delete_note', note_id=note.id) }}" method="POST" class="inline-form">
                            <button type="submit" class="delete-btn">Delete</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No notes uploaded yet.</p>
        {% endif %}
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section">
        <div class="section-header">
            <h3>Tasks:</h3>
            {% if current_user.role == 'teacher' %}
                <a href="{{ url_for('create_task', class_id=cls.id) }}" class="btn create-task-btn">Create Task</a>
            {% endif %}
        </div>

        {% if tasks %}
            <ul class="tasks-list">
            {% for task in tasks %}
                <li>
                    <strong>{{ task.title }}</strong> - {{ task.description }}
                    {% if task.filename %}
                        <a href="{{ url_for('uploaded_file', filename=task.filename) }}" class="view-link">View Task File</a>
                    {% endif %}

                    <!-- Teacher: view/edit/delete submissions -->
                    {% if current_user.role == 'teacher' %}
                        <a href="{{ url_for('update_task', task_id=task.id) }}" class="edit-link">Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" class="inline-form">
                            <button type="submit" class="delete-btn">Delete</button>
                        </form>

                        {% if task_submissions[task.id] %}
                            <ul class="submission-list">
                            {% for sub in task_submissions[task.id] %}
                                <li>{{ sub.student_name }} - 
                                    <a href="{{ url_for('uploaded_file', filename=sub.filename) }}" target="_blank">View</a>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <p>No submissions yet.</p>
                        {% endif %}
                    {% endif %}

                    <!-- Student: submit/edit/delete submission -->
                    {% if current_user.role == 'student' %}
                        {% if task.id in student_submissions %}
                            <p>Your submission:
                            <a href="{{ url_for('uploaded_file', filename=student_submissions[task.id].filename) }}" target="_blank">View</a>
                            <a href="{{ url_for('edit_submission', submission_id=student_submissions[task.id].id) }}" class="edit-link">Edit</a>
                            <form action="{{ url_for('delete_submission', submission_id=student_submissions[task.id].id) }}" method="POST" class="inline-form">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                            </p>
                        {% else %}
                            <a href="{{ url_for('submit_task', task_id=task.id) }}" class="btn submit-task-btn">Submit Task</a>
                        {% endif %}
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No tasks assigned yet.</p>
        {% endif %}
    </div>

    <!-- Leave Class Button for Students -->
    {% if current_user.role == 'student' %}
        <form action="{{ url_for('leave_class', class_id=cls.id) }}" method="POST">
            <button type="submit" class="leave-btn">Leave Class</button>
        </form>
    {% endif %}

    <!-- Delete Class Button for Teacher -->
    {% if current_user.id == cls.teacher_id %}
        <hr>
        <form action="{{ url_for('delete_class', class_id=cls.id) }}" method="POST"
              onsubmit="return confirm('Are you sure you want to delete this class? This will remove all notes, tasks, and members.')">
            <button type="submit" class="delete-class-btn">Delete Class</button>
        </form>
    {% endif %}
</div>
{% endblock %}
